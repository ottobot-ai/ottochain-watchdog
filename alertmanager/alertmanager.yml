# Alertmanager Configuration
#
# IMPORTANT: Replace TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID with your values
# before deploying. Alertmanager does not support env var substitution.
#
# Alternatively, use the generate-config.sh script.

global:
  resolve_timeout: 5m

route:
  # Default grouping and timing
  group_by: ['alertname', 'job', 'severity']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'telegram'

  routes:
    # Critical alerts - faster repeat
    - match:
        severity: critical
      receiver: 'telegram'
      repeat_interval: 1h
      continue: false

    # Warning alerts - normal repeat
    - match:
        severity: warning
      receiver: 'telegram'
      repeat_interval: 4h

receivers:
  - name: 'telegram'
    telegram_configs:
      - bot_token: 'YOUR_TELEGRAM_BOT_TOKEN'  # Replace with actual token
        chat_id: 0                             # Replace with actual chat ID
        parse_mode: 'HTML'
        message: |
          {{ if eq .Status "firing" }}ðŸš¨{{ else }}âœ…{{ end }} <b>{{ .Status | toUpper }}</b>

          <b>Alert:</b> {{ .CommonLabels.alertname }}
          <b>Severity:</b> {{ .CommonLabels.severity }}
          <b>Job:</b> {{ .CommonLabels.job }}

          {{ range .Alerts }}
          {{ if .Annotations.summary }}<b>Summary:</b> {{ .Annotations.summary }}{{ end }}
          {{ if .Annotations.description }}{{ .Annotations.description }}{{ end }}
          {{ end }}

          <i>{{ .ExternalURL }}</i>

  # Optional: Webhook receiver for OpenClaw integration
  # - name: 'openclaw'
  #   webhook_configs:
  #     - url: 'http://YOUR_OPENCLAW_HOST:PORT/webhook/alertmanager'
  #       send_resolved: true

inhibit_rules:
  # If critical is firing, suppress warning for same alert
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'job']

  # If AllNodesDown is firing, suppress individual NodeDown alerts
  - source_match:
      alertname: 'AllNodesDown'
    target_match:
      alertname: 'NodeDown'
    equal: []
